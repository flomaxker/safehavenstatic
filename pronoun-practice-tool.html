<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dutch Pronoun Game | Safe Haven Dutch Coaching</title>
    <meta name="description" content="A fun, gamified tool to master Dutch pronouns. Earn badges, track high scores, and unlock challenges.">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&family=Poppins:wght@500;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
          integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
          crossorigin="anonymous" referrerpolicy="no-referrer" />

    <link rel="stylesheet" href="style.css">
    
    <!-- Confetti Library -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>

    <!-- Custom styles for the interactive game -->
    <style>
        .tool-intro { text-align: center; margin-bottom: 2.5rem; }
        #category-selection { display: flex; flex-wrap: wrap; justify-content: center; gap: 1rem; margin-bottom: 3rem; }
        #category-selection .btn { min-width: 180px; }
        #start-screen { text-align: center; margin-bottom: 2rem; }
        #start-screen .btn { margin-top: 1rem; }
        #practice-area { background-color: var(--color-bg); padding: 1.5rem 2.5rem 2rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.07); border-left: 5px solid var(--color-primary); }
        .game-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; height: 30px; }
        #hint-container { font-size: 1rem; color: var(--color-text-light); }
        #hint-btn { background: none; border: 1px solid var(--color-text-light); color: var(--color-text-light); padding: 0.2rem 0.6rem; border-radius: 4px; cursor: pointer; transition: all 0.2s ease; }
        #hint-btn:hover:not(:disabled) { background-color: var(--color-primary); color: var(--color-white); border-color: var(--color-primary); }
        #hint-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        #sound-toggle { background: none; border: 1px solid var(--color-text-light); color: var(--color-text-light); padding: 0.2rem 0.6rem; border-radius: 4px; cursor: pointer; transition: all 0.2s ease; }
        #sound-toggle:hover { background-color: var(--color-primary); color: var(--color-white); border-color: var(--color-primary); }
        #streak-counter { font-size: 1.5rem; color: var(--color-primary); font-weight: 700; }
        #sentence-container { font-size: 1.5rem; color: var(--color-heading); margin-bottom: 1.5rem; line-height: 1.6; text-align: center; min-height: 70px; }
        #answer-input { display: block; width: 100%; max-width: 400px; margin: 0 auto 1rem auto; padding: 0.75rem 1rem; border: 2px solid #d1d5db; border-radius: 6px; font-size: 1.2rem; text-align: center; font-family: var(--font-body); transition: all 0.3s; }
        #answer-input:focus { outline: none; border-color: var(--color-primary); }
        #answer-input.correct-answer { border-color: var(--color-secondary); background-color: #f0fdfa; }
        #answer-input.incorrect-answer { border-color: var(--color-accent); background-color: #fff1f2; }
        .action-buttons { display: flex; justify-content: center; gap: 1rem; margin-top: 1.5rem; }
        #feedback-message { min-height: 1.5em; margin-top: 1.5rem; text-align: center; font-weight: 600; }
        #feedback-message.correct { color: var(--color-secondary); }
        #feedback-message.incorrect { color: var(--color-accent); }
        #completion-screen { text-align: center; padding: 3rem 1.5rem; background-color: #eff6ff; border: 1px solid #dbeafe; border-radius: 8px; }
        #completion-stats { display: flex; justify-content: center; gap: 2rem; margin: 1rem 0 2rem 0; text-align: center; flex-wrap: wrap; }
        .stat-item h4 { color: var(--color-text-light); margin-bottom: 0.25rem; font-size: 1rem; font-weight: 500; }
        .stat-item p { color: var(--color-primary); font-size: 1.8rem; font-weight: 700; margin: 0; }
        .new-high-score { color: var(--color-accent); font-weight: 700; }
        .hidden { display: none; }

        /* Achievements */
        #achievements-container { margin: 3rem auto; max-width: 600px; text-align: center; }
        #achievements-container h3 { color: var(--color-secondary); }
        .badge-grid { display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap; margin-top: 1.5rem; }
        .badge { width: 100px; text-align: center; }
        .badge .icon { font-size: 3rem; border-radius: 50%; width: 70px; height: 70px; line-height: 70px; margin: 0 auto; transition: all 0.4s ease; }
        .badge .title { font-size: 0.8rem; font-weight: 600; margin-top: 0.5rem; }
        .badge.locked .icon { background-color: #e5e7eb; color: #9ca3af; }
        .badge.locked .title { color: #9ca3af; }
        .badge.unlocked .icon { background-color: var(--color-secondary); color: var(--color-white); transform: scale(1.1); box-shadow: 0 4px 10px rgba(20, 184, 166, 0.4); }
        .badge.unlocked .title { color: var(--color-heading); }

        /* Tooltip for locked button */
        [data-tooltip] { position: relative; }
        [data-tooltip]:hover::after { content: attr(data-tooltip); position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); background-color: #374151; color: white; padding: 0.5rem 1rem; border-radius: 4px; font-size: 0.85rem; white-space: nowrap; z-index: 10; margin-bottom: 5px; opacity: 1; transition: opacity 0.2s; }

        /* Toast Notification */
        .toast { position: fixed; top: 20px; right: 20px; background-color: var(--color-secondary); color: white; padding: 1rem 1.5rem; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); z-index: 2000; transform: translateX(120%); transition: transform 0.5s ease-in-out; }
        .toast.show { transform: translateX(0); }
        .toast .emoji { margin-right: 0.75rem; font-size: 1.2rem; }

        @media (max-width: 768px) {
            #practice-area { padding: 1.5rem; }
            #sentence-container { font-size: 1.2rem; }
            #answer-input { font-size: 1.1rem; }
        }
    </style>
</head>
<body id="page-pronoun-game">
    <header class="header">
        <nav class="navbar container">
             <a href="index.html" class="logo-link">
                 <img src="Safe Haven Banner (groot)-2.png" alt="Safe Haven Dutch Coaching Banner" class="logo-banner">
            </a>
            <ul class="nav-menu" id="nav-menu">
                <li><a href="index.html#home" class="nav-link">Home</a></li>
                <li><a href="index.html#about" class="nav-link">About Me</a></li>
                <li><a href="index.html#approach" class="nav-link">Approach</a></li>
                <li><a href="blog.html" class="nav-link">Blog</a></li>
                <li><a href="feelings-flags.html" class="nav-link">Feelings</a></li>
                <li><a href="integration-checklist.html" class="nav-link">Checklist</a></li>
                <li><a href="index.html#contact" class="nav-link">Contact</a></li>
            </ul>
            <button class="nav-toggle" id="nav-toggle" aria-label="Menu"><i class="fas fa-bars"></i></button>
        </nav>
    </header>

    <main class="blog-post-container">
        <div class="container tool-content">

            <div class="tool-intro">
                <h1><span class="emoji">üèÜ</span> The Great Pronoun Game</h1>
                <p class="intro-text">Master Dutch pronouns in a fun way! Choose a category, track your high scores, and unlock achievements. Veel succes!</p>
            </div>
            <div id='start-screen'>
                <p>Welcome! Press Start to choose a category. You'll answer 10 questions per round. Type the missing word and hit Enter. Use hints if you're stuck ‚Äî they reset your streak. Score 8/10 in each category to unlock Challenge Mode. Your progress saves automatically and you can toggle sounds with the speaker icon.</p>
                <button id='start-btn' class='btn btn-primary'>Start</button>
            </div>
            <!-- Category Selection -->
            <div id="category-selection" class="hidden">
                <button class="btn btn-primary" data-category="subject">Subject Pronouns</button>
                <button class="btn btn-primary" data-category="object">Object Pronouns</button>
                <button class="btn btn-secondary" data-category="demonstrative">Demonstratives</button>
                <button id="mixed-btn" class="btn btn-secondary" data-category="mixed" disabled>Challenge Mode</button>
            </div>

            <!-- The Practice Area -->
            <div id="practice-area" class="hidden">
                <div class="game-header">
                    <div id="hint-container">
                        <button id="hint-btn">Hint</button>
                        <span id="hint-counter"></span>
                    </div>
                    <button id="sound-toggle" aria-label="Toggle sound"><i class="fas fa-volume-up"></i></button>
                    <div id="streak-counter"></div>
                </div>
                <div class="progress-bar-container">
                    <div id="progress-bar" class="progress-bar"></div>
                    <div id="progress-text" class="progress-text"></div>
                </div>
                <div id="sentence-container"></div>
                <input type="text" id="answer-input" placeholder="Type your answer" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
                <div id="feedback-message"></div>
                <div class="action-buttons">
                    <button id="check-btn" class="btn btn-primary">Check Answer</button>
                    <button id="next-btn" class="btn btn-secondary hidden">Next Question</button>
                </div>
            </div>

            <!-- Completion Screen -->
            <div id="completion-screen" class="hidden">
                <h2><span class="emoji">üéâ</span> Round Complete!</h2>
                <div id="completion-stats">
                    <div class="stat-item">
                        <h4>Score</h4>
                        <p id="final-score">0 / 10</p>
                    </div>
                    <div class="stat-item">
                        <h4>Best Streak</h4>
                        <p id="final-streak">0</p>
                    </div>
                    <div class="stat-item">
                        <h4>High Score</h4>
                        <p id="high-score">0 / 10</p>
                    </div>
                </div>
                <button id="play-again-btn" class="btn btn-primary">Play Another Round</button>
                <button id="practice-mistakes-btn" class="btn btn-secondary hidden">Practice My Mistakes</button>
            </div>

            <!-- Achievements -->
            <div id="achievements-container">
                <h3><i class="fas fa-medal"></i> Your Achievements</h3>
                <div class="badge-grid">
                    <div id="badge-beginner" class="badge locked" data-tooltip="Complete your first round">
                        <div class="icon"><i class="fas fa-seedling"></i></div>
                        <p class="title">Beginner</p>
                    </div>
                    <div id="badge-specialist" class="badge locked" data-tooltip="Get a perfect 10/10 score">
                        <div class="icon"><i class="fas fa-star"></i></div>
                        <p class="title">Specialist</p>
                    </div>
                    <div id="badge-onfire" class="badge locked" data-tooltip="Achieve a 5-answer streak">
                        <div class="icon"><i class="fas fa-fire"></i></div>
                        <p class="title">On Fire!</p>
                    </div>
                    <div id="badge-pro" class="badge locked" data-tooltip="Unlock and complete the Challenge Mode">
                        <div class="icon"><i class="fas fa-crown"></i></div>
                        <p class="title">Pronoun Pro</p>
                    </div>
                </div>
            </div>
            
        </div>
    </main>

    <div id="toast" class="toast hidden"></div>
    <audio id="correct-sound" src="https://cdn.freesound.org/previews/18/18665_6281-hq.mp3"></audio>
    <audio id="incorrect-sound" src="https://cdn.freesound.org/previews/240/240195_2953000-hq.mp3"></audio>
    <footer class="footer"></footer>

    <script src="script.js"></script> <!-- Your existing script for nav/footer -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const sentences = [
                { category: 'subject', sentence: '___ woon in een klein dorp.', answer: ['ik'], explanation: 'Use "ik" for the first person singular.' },
                { category: 'subject', sentence: 'Mijn broer heet David. ___ is 20 jaar oud.', answer: ['hij'], explanation: 'David is male, so we use "hij".' },
                { category: 'subject', sentence: 'De zon schijnt. ___ is warm vandaag.', answer: ['het'], explanation: 'Weather and conditions take "het".' },
                { category: 'subject', sentence: 'Mijn zus en ik gaan weg. ___ kopen kaartjes.', answer: ['wij', 'we'], explanation: 'For "my sister and I" use "wij" or "we".' },
                { category: 'subject', sentence: '(To a friend) Waarom drink ___ geen koffie?', answer: ['jij', 'je'], explanation: 'Informal singular "you" is "jij/je".' },
                { category: 'subject', sentence: '(To a group) Hebben ___ zin in een pizza?', answer: ['jullie'], explanation: 'Addressing a group uses "jullie".' },
                { category: 'subject', sentence: 'De buren zijn aardig. ___ hebben een hond.', answer: ['zij', 'ze'], explanation: 'Plural nouns take "zij/ze".' },
                { category: 'subject', sentence: '(Formal) Goedemorgen, heeft ___ een moment tijd?', answer: ['u'], explanation: 'Formal "you" is "u".' },
                { category: 'subject', sentence: 'Vandaag ga ___ vroeg naar huis.', answer: ['ik'], explanation: 'Talking about yourself again uses "ik".' },
                { category: 'subject', sentence: 'De kinderen spelen buiten. ___ maken veel lawaai.', answer: ['zij', 'ze'], explanation: '"De kinderen" is plural, so "zij/ze".' },

                { category: 'object', sentence: 'Ik zie de postbode. Ik geef ___ een brief.', answer: ['hem'], explanation: 'Use "hem" for a male person.' },
                { category: 'object', sentence: 'Mijn vriendin is jarig. Ik bel ___ meteen.', answer: ['haar'], explanation: 'Female person -> "haar".' },
                { category: 'object', sentence: 'Dit is mijn nieuwe telefoon. Vind je ___ mooi?', answer: ['hem'], explanation: '"Telefoon" is a de-word, so object pronoun is "hem".' },
                { category: 'object', sentence: 'Ik begrijp het niet. Kun je ___ helpen?', answer: ['mij', 'me'], explanation: 'First person object is "mij/me".' },
                { category: 'object', sentence: 'Onze leraar is ziek. We sturen ___ een kaart.', answer: ['hem'], explanation: 'Male teacher -> "hem".' },
                { category: 'object', sentence: 'Waar is mijn paspoort? Heb jij ___ gezien?', answer: ['het'], explanation: 'Het-word object stays "het".' },
                { category: 'object', sentence: 'De honden hebben dorst. Ik geef ___ water.', answer: ['ze', 'hen'], explanation: 'Plural animals/people use "ze/hen".' },
                { category: 'object', sentence: 'Kijk naar ___! Ik heb een nieuwe jas.', answer: ['mij', 'me'], explanation: 'Pointing to yourself uses "mij/me".' },
                { category: 'object', sentence: '(Formal) Meneer, kan ik ___ iets vragen?', answer: ['u'], explanation: 'Formal object pronoun is "u".' },
                { category: 'object', sentence: 'Wij hebben honger. De ober brengt ___ de menukaart.', answer: ['ons'], explanation: 'First person plural object is "ons".' },

                { category: 'demonstrative', sentence: '___ boek hier is erg spannend. (het-woord)', answer: ['dit'], explanation: 'Het-word nearby -> "dit".' },
                { category: 'demonstrative', sentence: 'Zie je ___ man daar? (de-woord)', answer: ['die'], explanation: 'De-word far away -> "die".' },
                { category: 'demonstrative', sentence: '___ pen op mijn bureau is van mij. (de-woord)', answer: ['deze'], explanation: 'De-word nearby -> "deze".' },
                { category: 'demonstrative', sentence: '___ huis in de verte is te koop. (het-woord)', answer: ['dat'], explanation: 'Het-word far away -> "dat".' },
                { category: 'demonstrative', sentence: 'Ik wil graag ___ twee croissants, alstublieft.', answer: ['deze'], explanation: 'Ordering items near you uses "deze".' },
                { category: 'demonstrative', sentence: 'Wat kost ___ schilderij daar aan de muur?', answer: ['dat'], explanation: 'Something far away -> "dat".' },
                { category: 'demonstrative', sentence: '___ stoelen hier zijn nieuw.', answer: ['deze'], explanation: 'Plural near objects -> "deze".' },
                { category: 'demonstrative', sentence: 'Vind je ___ jurk in de etalage mooi?', answer: ['die'], explanation: 'De-word far away -> "die".' },
                { category: 'demonstrative', sentence: '___ is een goed idee!', answer: ['dat', 'dit'], explanation: 'Referring to an idea uses "dat" or "dit".' },
                { category: 'demonstrative', sentence: 'Is ___ jouw glas hier?', answer: ['dit'], explanation: 'Het-word close by -> "dit".' },
            ];

            // --- DOM Elements ---
            const categorySelection = document.getElementById('category-selection');
            const practiceArea = document.getElementById('practice-area');
            const completionScreen = document.getElementById('completion-screen');
            const sentenceContainer = document.getElementById('sentence-container');
            const answerInput = document.getElementById('answer-input');
            const checkBtn = document.getElementById('check-btn');
            const nextBtn = document.getElementById('next-btn');
            const feedbackMessage = document.getElementById('feedback-message');
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            const streakCounter = document.getElementById('streak-counter');
            const hintBtn = document.getElementById('hint-btn');
            const hintCounter = document.getElementById('hint-counter');
            const finalScoreEl = document.getElementById('final-score');
            const finalStreakEl = document.getElementById('final-streak');
            const highScoreEl = document.getElementById('high-score');
            const playAgainBtn = document.getElementById('play-again-btn');
            const practiceMistakesBtn = document.getElementById('practice-mistakes-btn');
            const mixedBtn = document.getElementById('mixed-btn');
            const toast = document.getElementById('toast');
            const correctSound = document.getElementById('correct-sound');
            const incorrectSound = document.getElementById('incorrect-sound');
            const startScreen = document.getElementById("start-screen");
            const startBtn = document.getElementById("start-btn");
            const soundToggle = document.getElementById('sound-toggle');

            let soundEnabled = true;

            // --- Game State & Constants ---
            let currentSentences = [];
            let currentQuestionIndex = 0;
            let currentCategory = '';
            let score = 0;
            let currentStreak = 0;
            let bestStreakInRound = 0;
            let wrongQuestions = [];
            let totalQuestions = 10;
            let hintTokens = 3;
            let achievements = {};
            let highScores = {};
            const QUESTIONS_PER_ROUND = 10;
            const UNLOCK_SCORE = 8;

            // --- Core Game Logic ---
            function startGame(category, customList) {
                currentCategory = category;
                let filteredSentences = customList || sentences;
                if (!customList && category !== 'mixed') {
                    filteredSentences = sentences.filter(s => s.category === category);
                }
                currentSentences = customList ? shuffleArray(filteredSentences) : shuffleArray(filteredSentences).slice(0, QUESTIONS_PER_ROUND);
                totalQuestions = currentSentences.length;

                currentQuestionIndex = 0;
                score = 0;
                currentStreak = 0;
                bestStreakInRound = 0;
                hintTokens = 3;
                wrongQuestions = [];

                updateStreakDisplay();
                updateHintDisplay();
                categorySelection.classList.add('hidden');
                completionScreen.classList.add('hidden');
                practiceArea.classList.remove('hidden');
                displayQuestion();
            }

            function displayQuestion() {
                resetInput();
                updateProgressBar();
                const question = currentSentences[currentQuestionIndex];
                sentenceContainer.textContent = question.sentence;
            }

            function checkAnswer() {
                const userAnswer = answerInput.value.trim().toLowerCase();
                const correctAnswerArray = currentSentences[currentQuestionIndex].answer;
                
                if (!userAnswer) return;

                answerInput.disabled = true;
                hintBtn.disabled = true;
                checkBtn.classList.add('hidden');
                nextBtn.classList.remove('hidden');

                if (correctAnswerArray.includes(userAnswer)) {
                    feedbackMessage.textContent = 'Correct! üéâ';
                    feedbackMessage.className = 'correct';
                    answerInput.classList.add('correct-answer');
                    if (soundEnabled) correctSound.play();
                    triggerConfetti();
                    score++;
                    currentStreak++;
                    if(currentStreak > bestStreakInRound) bestStreakInRound = currentStreak;
                    checkAndAwardAchievement('onfire', currentStreak >= 5);
                } else {
                    const explanation = currentSentences[currentQuestionIndex].explanation || '';
                    let message = `Not quite. Correct was: ${correctAnswerArray.join(' / ')}`;
                    if (explanation) {
                        message += `. Tip: ${explanation}`;
                    }
                    feedbackMessage.textContent = message;
                    feedbackMessage.className = 'incorrect';
                    answerInput.classList.add('incorrect-answer');
                    if (soundEnabled) incorrectSound.play();
                    wrongQuestions.push(currentSentences[currentQuestionIndex]);
                    currentStreak = 0;
                }
                updateStreakDisplay();
            }

            function useHint() {
                if (hintTokens > 0) {
                    hintTokens--;
                    currentStreak = 0; // Cost of using a hint
                    updateStreakDisplay();
                    updateHintDisplay();
                    const correctAnswer = currentSentences[currentQuestionIndex].answer[0];
                    answerInput.value = correctAnswer.charAt(0);
                    answerInput.focus();
                }
            }

            function nextQuestion() {
                currentQuestionIndex++;
                if (currentQuestionIndex < totalQuestions) {
                    displayQuestion();
                } else {
                    showCompletion();
                }
            }

            function showCompletion() {
                // Update stats and save progress
                const oldHighScore = highScores[currentCategory] || 0;
                if (currentCategory !== 'mistakes' && score > oldHighScore) {
                    highScores[currentCategory] = score;
                }
                saveProgress();

                // Check for achievements
                checkAndAwardAchievement('beginner', true);
                if (currentCategory !== 'mistakes') {
                    checkAndAwardAchievement('specialist', score === QUESTIONS_PER_ROUND);
                    checkAndAwardAchievement('pro', currentCategory === 'mixed');
                }
                
                // Display final stats
                finalScoreEl.textContent = `${score} / ${totalQuestions}`;
                finalStreakEl.textContent = bestStreakInRound;
                if (currentCategory === 'mistakes') {
                    highScoreEl.textContent = '-';
                } else {
                    highScoreEl.textContent = `${highScores[currentCategory] || 0} / ${QUESTIONS_PER_ROUND}`;
                }
                if (score > oldHighScore && score > 0) {
                    highScoreEl.innerHTML += ` <span class="new-high-score">New Best!</span>`;
                }

                practiceMistakesBtn.classList.toggle('hidden', wrongQuestions.length === 0);
                practiceArea.classList.add('hidden');
                completionScreen.classList.remove('hidden');
                updateUIFromState();
            }
            
            // --- UI & Feedback ---
            function resetInput() {
                answerInput.value = '';
                answerInput.disabled = false;
                hintBtn.disabled = false;
                answerInput.className = '';
                feedbackMessage.textContent = '';
                feedbackMessage.className = '';
                checkBtn.classList.remove('hidden');
                nextBtn.classList.add('hidden');
                answerInput.focus();
            }

            function updateProgressBar() {
                const progress = ((currentQuestionIndex) / totalQuestions) * 100;
                progressBar.style.width = `${progress}%`;
                progressText.textContent = `Question ${currentQuestionIndex + 1} of ${totalQuestions}`;
            }

            function updateStreakDisplay() {
                if (currentStreak > 1) {
                    streakCounter.textContent = `${currentStreak} üî•`;
                } else {
                    streakCounter.textContent = '';
                }
            }

            function updateHintDisplay() {
                hintCounter.textContent = `(${hintTokens} left)`;
                hintBtn.disabled = hintTokens === 0;
            }

            function triggerConfetti() {
                if (currentStreak > 0 && (currentStreak + 1) % 5 === 0) {
                    // Bigger celebration for streak milestones
                    confetti({ particleCount: 200, spread: 100, origin: { y: 0.6 } });
                } else {
                    confetti({ particleCount: 80, spread: 60, origin: { y: 0.7 } });
                }
            }
            
            function showToast(message) {
                toast.textContent = message;
                toast.classList.remove('hidden');
                toast.classList.add('show');
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 4000);
            }

            // --- LocalStorage & Progress ---
            function saveProgress() {
                const progress = { highScores, achievements, sound: soundEnabled };
                localStorage.setItem('safeHavenPronounGame', JSON.stringify(progress));
            }

            function loadProgress() {
                const savedProgress = JSON.parse(localStorage.getItem('safeHavenPronounGame'));
                if (savedProgress) {
                    highScores = savedProgress.highScores || {};
                    achievements = savedProgress.achievements || {};
                    soundEnabled = savedProgress.sound !== false;
                }
            }

            function checkAndAwardAchievement(id, condition) {
                if (condition && !achievements[id]) {
                    achievements[id] = true;
                    saveProgress();
                    updateAchievementsUI();
                    const badge = document.getElementById(`badge-${id}`);
                    const message = badge.getAttribute('data-tooltip');
                    showToast(`üèÜ Achievement Unlocked: ${message}!`);
                }
            }
            
            function updateUIFromState() {
                // Update achievements display
                updateAchievementsUI();

                // Update Challenge Mode button state
                const allUnlocked = (highScores.subject >= UNLOCK_SCORE) && 
                                    (highScores.object >= UNLOCK_SCORE) && 
                                    (highScores.demonstrative >= UNLOCK_SCORE);
                
                if (allUnlocked) {
                    mixedBtn.disabled = false;
                    mixedBtn.removeAttribute('data-tooltip');
                } else {
                    mixedBtn.disabled = true;
                    mixedBtn.setAttribute('data-tooltip', `Score ${UNLOCK_SCORE}/10 in other categories to unlock`);
                }
            }

            function updateAchievementsUI() {
                for (const id in achievements) {
                    if (achievements[id]) {
                        document.getElementById(`badge-${id}`).classList.remove('locked');
                        document.getElementById(`badge-${id}`).classList.add('unlocked');
                    }
                }
            }

            function shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            }
            
            // --- Initial Setup & Event Listeners ---
            function updateSoundIcon() {
                const icon = soundToggle.querySelector('i');
                if (soundEnabled) {
                    icon.classList.remove('fa-volume-mute');
                    icon.classList.add('fa-volume-up');
                } else {
                    icon.classList.remove('fa-volume-up');
                    icon.classList.add('fa-volume-mute');
                }
            }

            function initialize() {
                startScreen.classList.remove("hidden");
                categorySelection.classList.add("hidden");
                practiceArea.classList.add("hidden");
                completionScreen.classList.add("hidden");
                loadProgress();
                updateUIFromState();
                updateSoundIcon();
            }

            categorySelection.addEventListener('click', (e) => {
                if (e.target.matches('button') && !e.target.disabled) {
                    startGame(e.target.dataset.category);
                }
            });

            checkBtn.addEventListener('click', checkAnswer);
            nextBtn.addEventListener('click', nextQuestion);
            hintBtn.addEventListener('click', useHint);
            soundToggle.addEventListener('click', () => {
                soundEnabled = !soundEnabled;
                updateSoundIcon();
                saveProgress();
            });
            practiceMistakesBtn.addEventListener('click', () => {
                completionScreen.classList.add('hidden');
                startGame('mistakes', wrongQuestions);
                wrongQuestions = [];
            });
            playAgainBtn.addEventListener("click", () => {
                completionScreen.classList.add("hidden");
                categorySelection.classList.remove("hidden");
            });

            startBtn.addEventListener("click", () => {
                startScreen.classList.add("hidden");
                categorySelection.classList.remove("hidden");
            });
            answerInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !checkBtn.classList.contains('hidden')) {
                    checkAnswer();
                } else if (e.key === 'Enter' && !nextBtn.classList.contains('hidden')) {
                    nextQuestion();
                }
            });

            initialize();
        });
    </script>

</body>
</html>